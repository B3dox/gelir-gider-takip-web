<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gelir-Gider Takip — ESEN GROUP</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb;
      --acc:#22c55e; --acc2:#38bdf8; --danger:#ef4444; --warn:#f59e0b;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(120deg,#0b1224,#111827 45%,#0b1224); color:var(--text); font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .container{max-width:1100px; margin:32px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    h1{font-size:26px; margin:0}
    .badge{background:linear-gradient(90deg,var(--acc2),var(--acc)); padding:6px 10px; border-radius:999px; font-weight:700; box-shadow:var(--shadow)}
    .card{background:rgba(17,24,39,.75); backdrop-filter: blur(8px); border:1px solid #1f2937; border-radius:var(--radius); box-shadow:var(--shadow)}
    .grid{display:grid; gap:14px}
    .grid-2{grid-template-columns:1.3fr .7fr}
    .controls{display:grid; grid-template-columns:repeat(6,1fr); gap:10px; padding:14px}
    label{font-size:12px; opacity:.9}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #233047; background:#0b1224; color:var(--text)}
    textarea{min-height:40px; resize:vertical}
    button{appearance:none; border:0; padding:10px 14px; border-radius:12px; color:#0b1224; font-weight:700; cursor:pointer}
    .btn{background:linear-gradient(90deg,var(--acc2),var(--acc))}
    .btn-ghost{background:#0b1224; color:var(--text); border:1px solid #243044}
    .btn-danger{background:linear-gradient(90deg,#ef4444,#f97316)}
    .toolbar{display:flex; gap:10px; align-items:center; padding:12px 14px; border-top:1px solid #1f2937; border-radius:0 0 var(--radius) var(--radius)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px; border-bottom:1px solid #1f2937}
    th{text-align:left; font-size:12px; color:#cbd5e1}
    tr:hover td{background:rgba(56,189,248,.08)}
    .right{text-align:right}
    .pill{padding:4px 8px; border-radius:999px; font-size:12px}
    .income{background:rgba(34,197,94,.12); color:#86efac}
    .expense{background:rgba(239,68,68,.12); color:#fca5a5}
    .summary{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; padding:14px}
    .kpi{padding:14px; background:#0b1224; border:1px solid #1f2937; border-radius:14px}
    .kpi h3{margin:0 0 4px; font-size:12px; color:#cbd5e1}
    .kpi div{font-size:20px; font-weight:800}
    .muted{opacity:.8}
    footer{opacity:.6; font-size:12px; text-align:center; padding:16px}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}.controls{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gelir‑Gider Takip <span class="badge">Local‑First</span></h1>
      <div class="muted">Veriler cihazında tutulur • İstersen dışa aktar</div>
    </header>

    <div class="grid grid-2">
      <section class="card">
        <form id="entryForm">
          <div class="controls">
            <div>
              <label>Tarih</label>
              <input type="date" id="date" required />
            </div>
            <div>
              <label>Tür</label>
              <select id="type">
                <option value="income">Gelir</option>
                <option value="expense">Gider</option>
              </select>
            </div>
            <div>
              <label>Kategori</label>
              <input id="category" placeholder="Örn. Kurye, Yakıt, Bakım" />
            </div>
            <div>
              <label>Tutar (₺)</label>
              <input id="amount" type="number" step="0.01" min="0" required />
            </div>
            <div>
              <label>Not</label>
              <input id="note" placeholder="Açıklama" />
            </div>
            <div style="display:flex; align-items:flex-end; gap:8px">
              <button class="btn" type="submit">Ekle</button>
              <button class="btn-ghost" type="button" id="clearForm">Temizle</button>
            </div>
          </div>
        </form>
        <div class="summary">
          <div class="kpi"><h3>Toplam Gelir</h3><div id="sumIncome">₺0</div></div>
          <div class="kpi"><h3>Toplam Gider</h3><div id="sumExpense">₺0</div></div>
          <div class="kpi"><h3>Net</h3><div id="sumNet">₺0</div></div>
        </div>
      </section>

      <aside class="card">
        <div class="toolbar" style="justify-content:space-between">
          <div style="display:flex; gap:8px; align-items:center; width:100%">
            <input id="search" placeholder="Ara: kategori veya not" />
            <select id="filterType">
              <option value="all">Tümü</option>
              <option value="income">Gelir</option>
              <option value="expense">Gider</option>
            </select>
            <button class="btn-ghost" id="exportCSV" type="button">CSV Dışa Aktar</button>
            <button class="btn-ghost" id="exportJSON" type="button">JSON Dışa Aktar</button>
            <button class="btn" id="saveFile" type="button">Dosyaya Kaydet</button>
            <input type="file" id="openFile" accept="application/json,.json" style="display:none" />
            <button class="btn-ghost" id="openBtn" type="button">Dosya Aç</button>
            <button class="btn-danger" id="wipe" type="button" title="Tüm verileri sil">Sıfırla</button>
          </div>
        </div>
        <div style="padding:0 14px 14px 14px; max-height:520px; overflow:auto">
          <table id="table">
            <thead>
              <tr>
                <th>Tarih</th><th>Tür</th><th>Kategori</th><th>Not</th><th class="right">Tutar</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </aside>
    </div>

    <footer>© ESEN GROUP — Cihazında saklanır. İstediğinde JSON/CSV olarak dışa aktar.</footer>
  </div>

<script>
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const storeKey = 'esen-group-ledger-v1';
let rows = JSON.parse(localStorage.getItem(storeKey)||'[]');

function format(n){return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(Number(n||0))}
function render(){
  const q = $('#search').value.toLowerCase();
  const f = $('#filterType').value;
  const tbody = $('#table tbody');
  tbody.innerHTML = '';
  let income=0, expense=0;
  rows
    .filter(r=> (f==='all'||r.type===f) && (r.category+" "+r.note).toLowerCase().includes(q))
    .sort((a,b)=>a.date.localeCompare(b.date))
    .forEach((r,i)=>{
      if(r.type==='income') income+=Number(r.amount); else expense+=Number(r.amount);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td><span class="pill ${r.type}">${r.type==='income'?'Gelir':'Gider'}</span></td>
        <td>${r.category||'-'}</td>
        <td>${r.note||''}</td>
        <td class="right">${format(r.amount)}</td>
        <td class="right"><button class="btn-ghost" data-i="${i}">Sil</button></td>`;
      tbody.appendChild(tr);
    });
  $('#sumIncome').textContent = format(income);
  $('#sumExpense').textContent = format(expense);
  $('#sumNet').textContent = format(income-expense);
  localStorage.setItem(storeKey, JSON.stringify(rows));
}

$('#entryForm').addEventListener('submit', e=>{
  e.preventDefault();
  const item = {
    date: $('#date').value || new Date().toISOString().slice(0,10),
    type: $('#type').value,
    category: $('#category').value.trim(),
    amount: parseFloat($('#amount').value||0),
    note: $('#note').value.trim()
  };
  if(!item.amount) return;
  rows.push(item);
  e.target.reset();
  render();
});
$('#clearForm').onclick = ()=> $('#entryForm').reset();
$('#search').oninput = render; $('#filterType').onchange = render;
$('#table').addEventListener('click',e=>{
  const i = e.target.dataset.i; if(i===undefined) return;
  rows.splice(i,1); render();
});
$('#wipe').onclick = ()=>{ if(confirm('Tüm verileri silmek istediğine emin misin?')){ rows=[]; render(); }}

// Export CSV
$('#exportCSV').onclick = ()=>{
  const headers = ['tarih','tur','kategori','not','tutar'];
  const csv = [headers.join(',')].concat(rows.map(r=>[r.date,r.type,r.category||'',(r.note||'').replace(/,/g,';'),r.amount].join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ledger.csv'; a.click();
}
// Export JSON
$('#exportJSON').onclick = ()=>{
  const blob = new Blob([JSON.stringify(rows,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ledger.json'; a.click();
}
// File System Access API (Chromium/Edge)
let fileHandle = null;
$('#saveFile').onclick = async()=>{
  try{
    if(!fileHandle){
      fileHandle = await window.showSaveFilePicker({suggestedName:'ledger.json', types:[{description:'JSON', accept:{'application/json':['.json']}}]});
    }
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(rows,null,2));
    await writable.close();
    alert('Dosyaya kaydedildi.');
  }catch(e){ console.log(e); alert('Tarayıcın bu özelliği desteklemiyor olabilir. JSON dışa aktar kullan.'); }
}
$('#openBtn').onclick = ()=> $('#openFile').click();
$('#openFile').onchange = async(e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  rows = JSON.parse(text||'[]');
  render();
}

// Defaults
if(!rows.length){
  rows = [
    {date:new Date().toISOString().slice(0,10), type:'income', category:'Kurye', note:'Günlük kazanç', amount:1200},
    {date:new Date().toISOString().slice(0,10), type:'expense', category:'Yakıt', note:'Benzin', amount:350},
  ];
}
render();
</script>
</body>
</html>
